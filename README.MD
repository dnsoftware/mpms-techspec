<div style="text-align: justify;">

# Техническое задание на создание отказоустойчивого майнинг-пула для нескольких криптовалют (Mining pool management system)

## Введение
### Цель документа

Настоящее техническое задание составляется с целью определения требований и условий для разработки, внедрения и эксплуатации майнинг-пула. Документ описывает ключевые аспекты проекта, включая функциональные и технические характеристики системы, требования к оборудованию и программному обеспечению, а также аспекты безопасности и масштабируемости.

Целью разработки майнинг-пула является обеспечение стабильной, безопасной и эффективной платформы для объединения вычислительных мощностей пользователей с целью коллективного добывания криптовалют. Это позволит участникам пула равномерно распределять награду за найденные блоки, обеспечивая справедливость, прозрачность и надежность процесса майнинга.

Документ предназначен для разработчиков, системных администраторов, специалистов по информационной безопасности и других заинтересованных сторон, участвующих в создании и эксплуатации майнинг-пула.


## Область применения

Разрабатываемый майнинг-пул предназначен для частных майнеров, профессиональных майнинг-ферм, а также предприятий, занимающихся добычей криптовалют. Он будет использоваться для коллективного майнинга цифровых активов с целью увеличения стабильности доходов и равномерного распределения вознаграждений между участниками.

Программный продукт применяется в среде распределенных вычислений. Доступ к пулу осуществляется через интернет, что позволяет использовать его в любой географической точке при наличии соответствующих вычислительных мощностей и подключения к сети.

Основными пользователями системы являются:

 - Владельцы частных и корпоративных майнинг-устройств (ASIC, GPU-фермы);
 - Операторы крупных  майнинг-центров;
 - Разработчики и администраторы, обеспечивающие техническую поддержку и эксплуатацию пула;
 - Финансовые аналитики и инвесторы, заинтересованные в прогнозировании доходности майнинга. 
 
Майнинг-пул ориентирован  на обеспечение высокой производительности, отказоустойчивости и безопасности, что делает его применимым, как для небольших групп энтузиастов, так и для крупных майнинговых объединений.


## 1. Общие требования
   ### 1.1 Цель разработки
   Целью разработки майнинг-пула является создание высокопроизводительной, надежной и безопасной платформы для коллективного майнинга криптовалют. Система должна обеспечить объединение вычислительных мощностей пользователей, оптимизацию распределения задач и справедливое распределение вознаграждений среди участников пула.

   Основные задачи, которые решает продукт:

   • **Повышение эффективности майнинга** – надежная, бесперебойная связь с пулом, снижение вероятности случайных потерь награды за счет совместного поиска блоков.  
   • **Обеспечение стабильного дохода** – участникам пула предоставляются разные модели начисления вознаграждений за их вклад в работу пула.  
   • **Масштабируемость и отказоустойчивость** – система должна поддерживать большое количество подключенных пользователей и гарантировать бесперебойную работу.  
   • **Безопасность** – защищенные каналы обмена данными (TLS), обеспечение целостности данных, прозрачные и надежные механизмы платежей.  
   • **Простота использования** – удобный интерфейс и поддержка различных устройств (ASIC, GPU-фермы, CPU).  

   Разработка майнинг-пула направлена на создание конкурентоспособного решения, способного работать в условиях высокой нагрузки, соблюдая современные требования к производительности, безопасности и прозрачности расчетов.

### 1.2 Пользователи системы
Система майнинг-пула предусматривает несколько категорий пользователей, каждая из которых обладает различными уровнями доступа и функциональными возможностями:

**Администраторы** – управляют работой пула, обеспечивают его техническое обслуживание и безопасность.

- Настройка и мониторинг серверов.
- Управление пользователями и правами доступа.
- Анализ производительности и логирование событий.
- Мониторинг работы майнинговых сервисов в реальном времени.
- Корректировка параметров работы майнинговых серверов.
- Обновление программного обеспечения и реализация мер безопасности.

**Майнеры (конечные пользователи)** – владельцы вычислительных мощностей, участвующие в майнинге.
- Подключение оборудования (ASIC, GPU-фермы, CPU).
- Отслеживание статистики работы (хешрейт, доходность, выполненные шары).
- Получение вознаграждений в соответствии с выбранной моделью выплат.
- Настройка параметров майнинга (выбор алгоритма, кошелька, рабочих узлов).

**Финансовые пользователи** (инвесторы, бухгалтеры, аналитики) – анализируют доходность и управляют финансами.

- Мониторинг доходов и расходов пула.
- Управление выплатами и учет транзакций.
- Анализ эффективности работы оборудования.

**Гости** (неавторизованные пользователи) – могут просматривать общедоступную информацию о пуле.

- Ознакомление с условиями работы пула.
- Просмотр статистики и публичных данных (например, общий хешрейт пула, последние найденные блоки).
- Регистрация и создание учетной записи для пользования сервисами, требующими авторизации.

Каждая категория пользователей имеет определенные права доступа и инструменты для эффективного взаимодействия с системой, что обеспечивает безопасность, удобство и прозрачность работы пула.


### 1.3 Предназначение продукта
Разрабатываемый майнинг-пул предназначен для объединения вычислительных мощностей пользователей с целью совместной добычи криптовалют. Он обеспечивает равномерное распределение награды за найденные блоки среди участников, пропорционально их вкладу, что делает майнинг более предсказуемым и стабильным.

Основные проблемы, которые решает продукт:

- **Нестабильность индивидуального майнинга – одиночные майнеры сталкиваются с высокой волатильностью доходов, поскольку вероятность нахождения блока мала. Пул решает эту проблему, распределяя награды среди всех участников.
• Оптимизация вычислительных мощностей – за счет эффективного распределения задач между подключенными устройствами повышается общая производительность майнинга.
• Упрощение процесса майнинга – пользователи получают удобный инструмент для мониторинга и настройки своего оборудования без необходимости глубоко разбираться в технических аспектах блокчейна.
• Обеспечение безопасности и прозрачности – система защищена от мошенничества и манипуляций с выплатами, обеспечивая честное распределение доходов.
Как будет использоваться продукт:
1. Пользователь регистрируется в системе (если необходимо для использования некоторых услуг), подключает свое оборудование.
2. Система распределяет задачи среди участников и агрегирует результаты.
3. Найденные блоки подтверждаются в блокчейне, и вознаграждение делится согласно установленной схеме распределения наград.
4. Пользователь может отслеживать свою статистику и получать выплаты на указанный кошелек.
Таким образом, майнинг-пул повышает рентабельность и доступность майнинга, позволяя как частным майнерам, так и крупным фермам эффективно использовать свои ресурсы.

### 1.4 Область применения
Майнинг-пул будет использоваться в различных условиях, где есть доступ к вычислительным мощностям и интернет-соединению. Его основная область применения включает в себя:

1. **Майнинг-фермы** – крупные объекты с высокоскоростными вычислительными мощностями, ориентированные на добычу криптовалют. Пул обеспечит эффективное объединение мощностей разных фермеров и оптимизацию их работы.
2. **Частные майнеры** – индивидуальные пользователи, которые используют свои вычислительные ресурсы (например, ASIC-устройства или GPU-фермы) для участия в коллективном майнинге.
3. **Дата-центры** – профессиональные компании, предоставляющие хостинг и облачные вычисления, которые могут использовать пул для объединения своих ресурсов и более эффективного майнинга.
4. **Криптовалютные стартапы и исследовательские проекты** – организации, которые могут использовать майнинг-пул как средство для тестирования и разработки новых алгоритмов и технологий.

Майнинг-пул может функционировать в условиях постоянного интернет-соединения и в любом месте, где доступна соответствующая вычислительная инфраструктура (серверы, майнинговые установки, дата-центры). Продукт также можно использовать в разных географических регионах, обеспечивая доступ к участникам по всему миру.

Кроме того, продукт будет востребован в условиях активного развития криптовалютных рынков, что предполагает его использование как для крупных коммерческих проектов, так и для отдельных пользователей, заинтересованных в стабилизации и увеличении своих доходов от майнинга.

### 1.5 Описание системы
Майнинг-пул представляет собой распределенную вычислительную систему, предназначенную для объединения вычислительных мощностей участников с целью совместного майнинга криптовалют. Основной задачей системы является эффективное распределение работы между подключенными участниками, а также справедливое распределение вознаграждений за выполненные вычисления.

В пуле используется Proof of Work (PoW) алгоритм консенсуса для подтверждения транзакций и защиты сети от атак. Майнеры (участники сети) выполняют сложные вычисления, чтобы доказать, что они потратили определённые вычислительные ресурсы на обработку данных.

## 2. Архитектура системы
   ### 2.1 Общая концепция архитектуры
   - Проект должен быть построен с использованием микросервисного подхода.  
   - Высоконагруженные узлы, отвечающие за вычисления должны быть масштабируемыми – при росте нагрузки иметь механизм для быстрого добавления мощностей в полуавтоматическом, а в перспективе и в полностью автоматическом режиме.
   - Компоненты системы должны быть отказоустойчивыми – при выходе из строя вычислительного узла поток запросов должен перенаправляться на рабочие узлы. Данные должны храниться в отказоустойчивых кластерах, чтобы при выходе из строя одного из узлов кластера данные не были потеряны.
   - Взаимодействие между микросервисами, а также запросы от пользователей должно вестись по защищенным протоколам (TLS, JWT токены)
   - Микросервисный подход в выборе архитектуры выбран по следующим причинам:
    
     - Специфика майнинга изначально подразумевает размещение серверов в нескольких географических зонах. Каждая криптовалюта имеет свою специфику – значит для каждой криптовалюты нужно разработать свой микросервис по решению задач генерации заданий, приему и проверки решений от майнеров.
     - Мы изначально планируем размещать сервера в трех географических зонах (Европа, Азия, Америка), то есть на каждую криптовалюту необходимо минимум три сервера, а при, например, пяти криптовалютах – 15 серверов.
     - В зависимости от метода вычисления вознаграждений (а их запланировано минимум три) в рамках одной криптовалюты будет несколько реализаций алгоритма подсчета наград. Для всех криптовалют методы вычисления наград работают в принципе одинаково (возможно с мелкими вариациями), поэтому имеет смысл вынести функционал вычисления вознаграждений в отдельный микросервис.
     - Три географические зоны, пять криптовалют, три метода вычисления вознаграждений дает 45 отдельных конфигурационных файлов, что влечет за собой необходимость реализации механизма централизованного изменения конфигураций.
     - При таком количестве серверов очень трудно следить за актуальностью адресов и портов для каждого микросервиса – необходима какая-то служба обнаружения сервисов (Service Discovery).
     - От такого количества серверов постоянно идет огромный поток данных, которые нужно где-то агрегировать, а потом строить различные выборки по накопленным данным. Из-за потенциально большого количества данных на добавление, а также для обработки миллионов записей в запросе традиционная реляционная база данных не подходит. Поэтому имеет смысл такие данные хранить в аналитической базе данных (ClickHouse) и вынести функционал работы с ней в отдельный микросервис.
     - Также выносим данные по майнерам и воркерам в отдельный микросервис. Он будет использоваться как справочник для остальных микросервисов, а также будет хранить актуальные характеристики работы воркеров и отдавать их пользователям.
     - Серверов для майнинга отдельной криптовалюты может быть много, но сервис платежей по этой криптовалюте нужен только один. Поэтому его тоже выносим в отдельный микросервис. К тому же этот сервис не подразумевает высоких нагрузок, поэтому для его работы можно использовать слабый сервер или даже можно разместить эту службу на одном сервере с другими микросервисами.
     - Также логично выделить отдельный микросервис для рассылки уведомлений о происходящих в системе событиях. Эти уведомления могут рассылаться как пользователям, так и администраторам. Уведомления могут иметь как штатный характер – для отображения текущих параметров работы воркеров, найденных шарах, блоках и т.д., так и алерты для администратора при возникновении критических событий: аномальная нагрузка, падение сервиса, заканчивающееся место на диске и тому подобное.
     - Работы по регистрации и авторизации пользователей также выносим в отдельный микросервис.
     - Для управления входящими запросами к микросервисам в этой распределённой системе необходим отдельным микросервис API Gateway. Он выполняет роль единой точки входа для клиентов (мобильных приложений, веб-приложений, других сервисов) и распределяет запросы между бэкенд-сервисами. Может использоваться для балансировки нагрузки, аутентификации  и авторизации, кеширования, мониторинга и логирования, огранияения количества запросов (Rate Limiter), а также для маршрутизации и агрегирования запросов к нужным микросервисам.


### 2.2 Основные принципы построения микросервисной архитектуры проекта
**Декомпозиция на независимые сервисы**

- Каждый микросервис выполняет одну конкретную бизнес-задачу (принцип единственной ответственности).
- Разделение по доменным областям (DDD – Domain-Driven Design).

**Слабая связанность и автономность**
- Каждый сервис разрабатывается, разворачивается и масштабируется независимо от других.
- Минимизация зависимостей между сервисами.

**Обмен данными через API**
- Взаимодействие микросервисов происходит через REST API, gRPC, WebSockets, а также через очереди сообщений (Kafka, RabbitMQ).
- Использование стандартных протоколов (JSON, Protobuf).

**Разделенные хранилища данных**
- Каждый микросервис управляет своей собственной базой данных (NoSQL, SQL).
- Исключается прямая зависимость между сервисами через общую БД.

**Автоматизированное развертывание и оркестрация**
- Ansible для простой и удобной автоматизации без сложных инструментов.
- Использование контейнеризации (Docker, в перспективе Kubernetes).
- CI/CD-пайплайны для автоматического деплоя и обновления сервисов (Gitlab CI).

**Масштабируемость и отказоустойчивость**
- Возможность горизонтального масштабирования отдельных сервисов (сервера генерации заданий и проверки решений).
- Отказоустойчивые кластеры баз данных (PostgreSQL, ClickHouse, etcd) и очередей сообщений (Kafka, RabbitMQ)

**Мониторинг и логирование**
- Централизованный мониторинг (Prometheus, Grafana).
- Логирование (EFK Stack – Elasticsearch, Fluentbit, Kibana)
- Трассировка запросов (OpenTelemetry, Otel Collector, Grafana Tempo, Grafana).

**Безопасность и аутентификация**
- Использование API Gateway для маршрутизации и защиты сервисов.
- Аутентификация через JWT.
- Использование защищенных TLS соединений


### 2.3 Логическая архитектура

Очень упрощенная схема логической архитектуры выглядит как на рисунке ниже:

![Логическая архитектура](images/logic-scheme.png)

Стрелками обозначено направление движения данных.

Майнер подключается к микросервису **Share checker** получает задание и отправляет решение (шару).  Далее данные шар накапливаются в **Share processor** откуда могут быть запрошены пользователем через **API Gateway** или же быть использованы при подсчете вознаграждения в **Miners rewards** после нахождения блока.

После подтверждения блока служба **Miners rewards** обменивается данными с **Miners payouts** для начисления средств на балансы майнеров. При достижении порогового значения служба **Miners rewards** производит выплаты майнерам.

Все службы могут генерировать уведомления, которые с помощью **Notification manager** рассылаются нужным адресатам.

Также для некоторого функционала может быть необходима авторизация пользователя – для этих целей есть служба **User manager**.


### 2.4 Физическая архитектура
Все компоненты системы размещаются на VDS серверах. В перспективе инфраструктурные компоненты (базы данных, брокеры сообщений и т.п.) можно будет размещать в облаке.

#### 2.4.1. API Gateway
- **Роль:** Обработка HTTP/HTTPS запросов от клиентов (пользователи и администраторы) и  распределяет запросы между бэкенд-сервисами.
- **Технологии**: Golang, TLS, JWT, REST, Websocket
- **Размещение**: виртуальный выделенный сервер (VDS). Для отказоустойчивости можно развернуть несколько экземпляров API Gateway за балансировщиком HAProxy. В свою очередь при таком варианте HAProxy сам станет точкой отказа, поэтому можно использовать еще один HAProxy в качестве резервного и переключаться между основным и резервным с помощью DNS-based Failover решения у провадера DNS.
- **Масштабирование:** При повышении нагрузки можно добавлять сервера с API Gateway, а HAProxy настроить на равномерное распределение запросов между этими серверами. Но вариант, когда API Gateway перестанет справляться маловероятен конечно.

#### 2.4.2. Kafka кластер с высокой доступностью
- **Роль:** прием потока шар от майнинг серверов и передача их в сервис обработки и хранения шар, сбор логов и метрик со всей системы и доставки их потребителям, другой обмен данными с микросервисами по модели издатель-подписчик.
- **Технологии:** Apache Kafka, Zookeeper, UI for Kafka.
- **Размещение:** кластер из трех VDS с репликацией (или развертывание в облаке в разных зонах доступности) для высокой доступности и отказоустойчивости.
- **Масштабирование:** для масштабирования добавляем больше брокеров в кластер.

#### 2.4.3. RabbitMQ кластер с высокой доступностью
- **Роль:** гарантированная доставка критических данных (данные найденного блока, данные по начислениям вознаграждений) в условиях невысокой планируемой нагрузки (в отличии от Kafka с его потоками данных)
- **Технологии:** RabbitMQ
- **Размещение:** кластер из трех VDS с репликацией очередей (или развертывание в облаке в разных зонах доступности) для высокой доступности и отказоустойчивости.
- **Масштабирование:** добавление нового узла в кластер.

#### 2.4.4. Отказоустойчивый PostgreSQL кластер
- **Роль:** хранение данных микросервисов (майнеры, воркеры, пользователи, блоки, вознаграждения, балансы, выплаты)
- **Технологии:** HAProxy, etcd, PostgreSQL, pgBouncer, Patroni.
- **Размещение:** отказоустойчивый кластер из трех VDS с репликацией, выбором лидера, восстановлением после сбоев.
- **Масштабирование:** при увеличении нагрузки на чтение, можно просто добавлять ноды-реплики только для чтения (HAProxy служит балансировщиком нагрузки на read-only реплики). Также можно подумать над шардированием или же просто разделить базу данных по криптовалютам. То есть делать отдельный кластер для каждой криптовалюты.

#### 2.4.5. ClickHouse кластер
- **Роль:** хранение аналитических данных (используется для хранения данных шар и выполнения агрегационных запросов к ним). При потенциальном потоке данных в тысячи записей в секунду нужна СУБД  с высокой скоростью вставки и возможностью быстрых выборок по большому числу записей.
- **Технологии:** ClickHouse, Zookeeper
- **Размещение:**  отказоустойчивый кластер из трех VDS (или развертывание в облаке)
- **Масштабирование:** добавление новых серверов в кластер, шардирование (sharding) и репликация данных.

#### 2.4.6. Блокчейн нода
- **Роль:** хранение полной копии блокчейна (все блоки и транзакции), проверка их корректность, создание новых блоков, проверка новых транзакций и блоков на соответствие правилам сети, поддержание целостности блокчейна, распространение проверенных данных другим нодам.
- **Технологии:** зависят от каждой конкретной криптовалюты
- **Размещение:** на отдельном VDS
- **Масштабирование:** простое добавление нового сервера

#### 2.4.7. ETCD кластер
- **Роль:** распределенной хранилище для хранение конфигураций микросервисов, обнаружение сервисов (Service Discovery), Patroni storage (для PostgreSQL кластера)
- **Технологии:** etcd, etcd-keeper
- **Размещение:** кластер с нечетным количеством узлов-VDS в разных зонах доступности.
- **Масштабирование:** не предназначен для хранения больших объемов данных, достаточно 3-5 узлов.

#### 2.4.8. Shares checker микросервис
Майнинг сервер (майнинг пул, микросервис формирования задач для майнеров и проверки решений от них)

- **Роль:** Golang микросервис, разработанный под конкретную криптовалюту, получает задачу из блокчейн ноды, дробит ее на подзадачи и распределяет их между майнерами. Получает от майнеров решения, проверяет их и передает в микросервис обработки и хранения.
- **Технологии:** Golang, Redis, Nginx, Fluentbit, Kafka, RabbitMQ, Stratum, Blockchain API
- **Размещение:** один VDS – один микросервис. Как правило должен размещаться на одном сервере с блокчейн нодой для минимизации сетевых задержек.
- **Масштабирование:** при увеличении количества подключений можно добавлять сервера в разные географические зоны. Например, имея на старте сервера в Европе, Азии и Северной Америке, можно добавить сервера в Южной Америке, России, Казахстане и т.д. В случае очень большого наплыва пользователей в конкретной географической зоне можно добавить рядом несколько серверов и перед ними поставить балансировщик HAProxy, равномерно распределяющий запросы по этим серверам.

#### 2.4.9. Shares processor микросервис
- **Роль:** Golang микросервис дял получения потока решений от майнеров, сохранение их в базу, формирование агрегированных данных для пользователей и для формирования массива данных для расчета вознаграждений.
- **Технологии:** Golang, Kafka, Clickhouse, gRPC, REST
- **Размещение:** один VDS – один микросервис. Размещается на одном сервере с Clickhouse нодой, куда и будет вести запись/чтение.
- **Масштабирование:** можно рядом с каждой Clickhouse нодой разместить по микросервису, каждый из которых забирает из очереди только свои данные по какой-то криптовалюте. Можно также подумать над отдельным сервисом балансировщиком.

#### 2.4.10. Miners processor микросервис
- **Роль:** Golang микросервис для работы с данными майнеров и воркеров. Заведение новых майнеров и воркеров в базе, выдача данных по ним по внешним запросам. Хранение текущих параметров работы майнеров/воркеров.
- **Технологии:** Golang, PostgreSQL, Kafka, gRPC, REST
- **Размещение:** VDS сервер
- **Масштабирование:** добавление нескольких экземпляров + балансировщик HAProxy

#### 2.4.11. Miners rewards микросервис
- **Роль:** Golang микросервис для обработки найденных блоков, вычисления и хранения вознаграждений за блок.
- **Технологии:** Golang, PostgreSQL, RabbitMQ, gRPC, REST
- **Размещение:** VDS сервер
- **Масштабирование:** Микросервис ненагруженный, поэтому можно просто держать резервный на случай выхода основного из строя.

#### 2.4.12.  Miners payouts микросервис
- **Роль:** Golang микросервис для осуществления выплат. Отдельная разработка для каждой криптовалюты.
- **Технологии:** Golang, PostgreSQL, Kafka, RabbitMQ, gRPC, REST, Blockchain API
- **Размещение:** VDS сервер. Отдельный или один из серверов с Shares checker
- **Масштабирование:** на каждую криптовалюту свой микросервис. Микросервис ненагруженный, поэтому можно просто держать резервный на случай выхода основного из строя.

#### 2.4.13.  Notification manager микросервис
- **Роль:** Golang микросервис для рассылки уведомлений. При возникновении событий о которых необходимо уведомить пользователя или администратора такие события пишуться в очередь Kafka, откуда их потом забирает этот сервис и рассылает нужным получателям, в зависимости от типа уведомления. Алерты – в Telegram администратору или подписанному пользователю, мониторинг – в фронтенд админку через Websocket и т.п.
- **Технологии:** Golang, PostgreSQL, Kafka, gRPC, Websocket, Telegram Bot API
- **Размещение:** VDS сервер.
- **Масштабирование:** добавляем сервер + экземпляр микросервиса. Микросервис добавляем в группу подписчиков на нужные топики Kafka.

#### 2.4.14.  User manager микросервис
- **Роль:** для некоторых действий (реферальная программа, дополнительный функционал) может понадобиться регистрация и авторизация пользователей. Этот сервис как раз для этого.
- **Технологии:** Golang, PostgreSQL, JWT
- **Размещение:** один из VDS серверов.
- **Масштабирование:** на начальном этапе не требуется

#### 2.4.15.  Telegram miner bot микросервис
- **Роль:** дополнительный инструмент наблюдения за майнингом для пользователей. Просмотр балансов кошельков, статусов воркеров, подсчет доходов, уведомления об отключениях воркеров, прочие оповещения.
- **Технологии:** Golang, PostgreSQL, Telegram bot API
- **Размещение:** один из VDS серверов.
- **Масштабирование:** на начальном этапе не требуется

#### 2.4.16.  EFK - сбор, обработка и визуализация логов
- **Роль:** сбора и обработки логов, их храненние и индексация, веб-интерфейс для визуализации данных логов (поиск и фильтрация, анализ, графики и диаграммы)
- **Технологии:** Elasticsearch, Fluentbit, Kibana, Logstash
- **Размещение:** один или несколько VDS серверов.
- **Масштабирование:** Elasticsearch – добавление нового узла в кластер, Kibana – дополнительный экземпляр + балансировщик HAProxy.

#### 2.4.17.  OpenTelemetry - сбор, обработка и визуализация метрик и трейсов
- **Роль:** Сбор, хранение и анализа метрик получаемых с серверов и от микросервисов.  Сбор, хранение и анализ распределённых трассировок (distributed traces) - отслеживание путей запросовв микросервисах, их анализ, диагностирование ошибок.
- **Технологии:** Prometheus, Grafana, OpenTelemetry Collector, Grafana Tempo
- **Размещение:** один или несколько VDS серверов.
- **Масштабирование:**  
  - **Prometheus** изначально разработан как система с однопоточным сбором метрик, но при высоких нагрузках или в крупных кластерах можно распределить эту нагрузку между несколькими экземплярами Prometheus. Можно применить шардирование - разделение инфраструктуры на части, где каждый Prometheus-экземпляр собирает метрики только с определенного подмножества целей.
  - **Tempo** можно запускать как несколько независимых экземпляров, каждый из которых будет обрабатывать часть входящих трассировок.

  - **Otel Collector** - основной способ масштабирования - запуск нескольких экземпляров Otel Collector. Каждый экземпляр работает независимо и обрабатывает часть входящих данных.


Каждый указанный выше микросервис может размещаться как на отдельном VDS сервере, так и в комбинации с другими компонентами (для минимизации затрат) на одном VDS сервере в зависимости от планируемой нагруженности.

Инфраструктурные компоненты (кластера Postgresql, etcd, Clickhouse, Kafka, RabbitMQ, OpenTelemetry) при небольших начальных нагрузках, тоже могут быть размещены по соседству на одном VDS сервере ради экономии средств на начальном этапе функционирования системы.


### 2.5 Программная архитектура
Программная архитектура системы описывает структуру программного обеспечения, основные компоненты, их взаимодействие и технологии, используемые для реализации функциональности. Архитектура системы построена на основе микросервисной архитектуры, что обеспечивает гибкость, масштабируемость и легкость поддержки.

#### 2.5.1 Общая схема проекта

![Общая схема](images/global-structure.png)

В высоком разрешении на [этой странице](https://laradrom.ru/struktura-i-komponenty-majning-pula/).

Пояснения к условным обозначениям:

- **Пунктирной рамкой** очерчены логические компоненты системы (микросервисы).
- **Шестиугольниками** разных цветов обозначены непосредственно бинарники микросервисов (Golang программы) – то, что собственно и реализует программист.
- **Стрелками** обозначены связи между компонентами: запросы, команды, потоки данных.
- **Значки внутри шестиугольников** обозначают внутренние подсистемы в программе, отвечающие за определенный функционал:
  - **SD** – Service Discovery. Все микросервисы пользуются механизмом обнаружения сервисов, то есть других микросервисов с которыми они взаимодействуют.
  - **CMS** – Config Management System. Все микросервисы загружают свою конфигурацию из отказоустоучивого кластера etcd.
  - **синий круг** – микросервис пишет логи в систему логирования
  - **красный круг** – микросервис пишет метрики в систему сбора метрик
  - **зеленый круг** – микросервис пишет трейсы систему в сбора, хранения и запроса трейсов
  - **wallets cache** – кеш данных майнеров и воркеров в оперативной памяти программы

- **Значок монитора** – означает пользовательский интерфейс.
- **Цилиндр** – база данных. Подразумевается отказоустойчивый кластер.
- **Подписанные прямоугольники в цилиндрах** – названия основных таблиц в базе.
- **Цилиндр на боку** (труба) – очередь сообщений.
- **Подписанные прямоугольники в цилиндрах на боку** – названия топиков или очередей.
- **Fluentbit** – агент сбора логов.


#### 2.5.2 Клиентская часть

- **Frontend users** (Фронтенд пользователя). 
  - **Описание:** SPA приложения на Vue.js. Веб-приложение в браузере. Асинхронная подгрузка данных через API Gateway через AJAX/Fetch API и WebSocket.   
Страница в интернете, где майнеры просматривают текущее состояние пула, статистику работы своих воркеров, найденные блоки, распределение наград за найденный блок, параметры подключения и т.д.
  - **Технологии:** Vue.js (Javascript), HTML, CSS, REST, Websocket, Nodejs, Vite
  - **Функции:** Отображение пользовательского интерфейса, обработка действий пользователя, отправка запросов на сервер (API Gateway).


- **Frontend admin** (Фронтенд администратора)
  - **Описание:** SPA приложения на Vue.js. Веб-приложение в браузере. Асинхронная подгрузка данных через API Gateway через AJAX/Fetch API и WebSocket.   
   Защищенная паролем страница в интернете, где администратор может в режиме реального времени наблюдать за текущим состоянием майнинг серверов, просматривать балансы, изменять параметры и т.д.
  - **Технологии:** Vue.js (Javascript), HTML, CSS, REST, Websocket, Nodejs, Vite
  - **Функции:** Отображение администраторского интерфейса, отправка запросов на сервер (API Gateway), изменение параметров работы системы и т.д (более подробно в требованиях к админке).

- **Telegram user client**  
  - **Описание:** подписка в Телеграме на Telegram miner bot
  - **Технологии:** Telegram
  - **Функции:** Отображение интерфейса отправки запросов в Telegram боту, отправка запросов в Telegram miner bot микросервис.


#### 2.5.3 Backend API Gateway

  - **Описание:** Обработка HTTP/HTTPS, Websocket запросов от клиентов (пользователи и администраторы) и  распределяет запросы между бэкенд-сервисами.
  - **Технологии:** Golang, TLS, JWT, REST, Websocket
  - **Функции:** 
    - обработка HTTP запросов
    - обработка HTTPS запросов
    - обработка Websocket запросов
    - агрегация данных с нескольких микросервисов в один ответ


#### 2.5.4 Микросервисы
##### 1. Shares checker

![Shares checker](images/shares-checker-scheme.png)

- **Описание:** Воркеры майнеров подключаются к определенным портам приложения и ожидают задачи. Программа через blockchain API (у каждой криптовалюты свой API) получает из ноды криптовалюты задание для решения. Дробит его на более мелкие задачи и рассылает подключенным майнерам. Майнеры ищут решение и при нахождении такого отсылают его обратно. Микросервис проверяет правильность решения. Если решение неверное – отклоняет его, если верное – отправляет в топик Kafka для последующей обработки. При нахождении решения блока – отправляет его в очередь RabbitMQ для дальнейшей обработки другим микросервисом.
- **Технологии:** Golang, Redis, Nginx, Fluentbit, Kafka, RabbitMQ, Stratum, Blockchain API
- **Функции:** 
  - TCP/HTTP сервер принимает входящие подключения воркеров майнера
  - Парсинг команд воркеров (реализация протокола Stratum)
  - Периодическое получение заданий из blockchain ноды через ее Blockchain API
  - Формирование задач майнерам (протокол Stratum)
  - Рассылка задач майнерам
  - Прием и проверка решений майнеров
  - Отправка решений (шар) в топик Kafka
  - Отправка решения блока в очередь RabbitMQ
  - Отправка решения блока в blockchain ноду (Blockchain API)
  - Отправка возникающих ошибок в соответствующий топик Kafka для последующей обработки
  - Отправка событий воркеров в соответствующий топик Kafka (подключение, отключение и т.п.)
  - Каждый микросервис имеет свой доменный адрес, для удобного подключения майнеров. Поэтому используется Nginx для связывает доменного имя с сервером.
  - Динамическая коррекция сложности каждого конкретного воркера для снижения нагрузки на сервер и равномерной выдачи заданий воркеру (vardif).
  - Хранение сложностей воркеров (vardiffs) в кэше Redis для быстрого их получения при подключении воркера и для избежания их потери в момент переподключения воркера. 


##### 2. Shares processor

![Shares processor](images/shares-processor-scheme.png)

- **Описание:** Микросервис читает поток данных найденных решений (шар) из топика Kafka, нормализует эти данные (сопоставляет названия майнеров/воркеров с их кодами) и сохраняет нормализованные данные в Clickhouse. Принимает и обрабатывает агрегационные запросы с фронтенда (от API Gateway). Формирует данные для микросервиса Miners rewards – массив данных по шарам блока.
- **Технологии:** Golang, Kafka, Clickhouse, gRPC, REST
- **Функции:** 
  - чтение данных шар из топика Kafka
  - сохранение данных шар в Clickhouse
  - запрос данных майнеров/воркеров из микросервиса Miners processor (gRPC)
  - формирование массива данных по блоку по запросу из микросервиса Miners rewards
  - формирование агрегированных данных по запросам с фронтенда: текущие хешрейты воркеров, майнеров и пула в целом; 
  - формирование агрегированных данных для построения графиков хешрейтов воркеров, майнеров и пула
  - поиск даты последней найденной шары для конкретного воркера
  - прочие аналитические запросы

##### 3. Miners processor

![Miners processor](images/miners-processor-scheme.png)

- **Описание:** Микросервис управляющий данными майнеров/воркеров.
- **Технологии:** Golang, PostgreSQL, Kafka, gRPC, REST
- **Функции:**
  - Прием наименований майнеров/воркеров из микросервиса Shares processor (gRPC)
  - Заведение нового майнера/воркера в базе, если его еще там нет (PostgreSQL)
  - Поиск идентификатора майнера/воркера в базе по запросам из внешних микросервисов (Shares processor, Miners rewards, Miners payouts, API Gateway)
  - Получение событий из Kafka, касающихся майнеров и воркеров и их обработка

##### 4. Miners rewards

![Miners rewards](images/miners-rewards-scheme.png)

- **Описание:** После нахождения и подтверждения блока микросервис делает запрос к микросервису Shares processor на получение данных по вложенным усилиям каждого майнера по нахождению блока. На основании этих данных, в зависимости от метода вычисления вознаграждений, подсчитывается награда каждого воркера. Данные по наградам заносятся в базу.
- **Технологии:** Golang, PostgreSQL, RabbitMQ, gRPC, REST
- **Функции:**
  - Получение данных по найденному блоку из очереди block_found RabbitMQ
  - Сохранение данных блока в базе PostgreSQL
  - Отправка ожидающего блока в очередь pending_blocks RabbitMQ (Transactional Outbox паттерн)
  - Получение данных подтвержденного блока из очереди block_confirm RabbitMQ
  - Запрос данных по усилиям каждого воркера при нахождении блока из микросервиса Shares processor (gRPC)
  - Вычисление награды каждого майнера/воркера за найденным блок
  - Сохранение данных о наградах в базу PostgreSQL
  - Отправка данных о наградах в очередь worker_block_rewards RabbitMQ
  - Запросы идентификаторов майнеров/воркеров из микросервиса Miners processor (gRPC)
  - Обработка запросов с фронтенда через API Gateway (REST). Данные по распределению наград за блок между майнерами, данные по наградам в разрезе майнера/воркера, данные по найденному блоку.

##### 5. Miners payouts

![Miners payouts](images/miners-payouts-scheme.png)

- **Описание:** Формирование балансов майнеров и осуществление выплат на кошельки майнеров.
- **Технологии:** Golang, PostgreSQL, Kafka, RabbitMQ, gRPC, REST, Blockchain API
- **Функции:**
  - Получение из очереди pending_blocks RabbitMQ данных ожидающего подтверждения блока
  - Сохранение ожидающего блока в базе PostgreSQL
  - Периодическая проверка ожидающих блоков на предмет их подтвержденности в blockchain ноде (Blockchain API)
  - После подтверждения блока – отправка данных о подтверждении в очередь block_confirm  RabbitMQ
  - Получение данных о начисленных вознаграждениях из очереди worker_block_rewards
  - Добавление средств на баланс майнеров в базе PostgreSQL согласно полученным данным о вознаграждениях
  - Периодическая проверка балансов майнеров на предмет превышения порогового значения выплаты. При превышении порога – подготовка платежа на кошелек майнера
  - Платеж на кошелек майнера через Blockchain API.
  - Ожидание подтверждения платежной транзакции и отправка подтверждения в топик Kafka
  - Оправка событий по платежам и по ошибкам в соответствующие топики Kafka
  - Получение данных кошельков из микросервиса Miners processor
  - Обработка запросов с фронтенда через API Gateway


##### 6. Notification manager

![Notification manager](images/notification-manager-scheme.png)
       
- **Описание:** Рассылка уведомлений о событиях пользователям и администратору, трансляция событий в реальном времени на фронтенд пользователя и администратора,   отправка событий и алертов в Telegram
- **Технологии:** Golang, PostgreSQL, Kafka, gRPC, Websocket, Telegram Bot API
- **Функции:** 
  - Чтение событий из топиков Kafka
  - Сохранение событий в базу PostgreSQL
  - Рассылка сообщений о происходящих изменениях через Websocket API Gateway в броузер клиента (текущее усилие добычи, текущий хешрейт, платежи, нахождение блока и т.д.)
  - Рассылка сообщений о происходящих изменениях через Websocket API  Gateway в админку (текущие приходящие шары, статусы серверов, ошибки, алерты и другие характеристики)
  - Рассылка уведомлений и алертов в Telegram боты пользователя (нахождение блока, прерывание работы воркера) и администратора (падение сервера, критическая нагрузка и т.п.)

##### 7. User manager

![User manager](images/user-manager-scheme.png)

- **Описание:**  регистрация и авторизация пользователей
- **Технологии:** Golang, PostgreSQL, JWT
- **Функции:**
  - регистрация пользователя
  - аутентификация.авторизация пользователя
  - выдача JWT токена


##### 8. Telegram miner bot

![Telegram miner bot](images/tg-miner-bot-scheme.png)

- **Описание:** дополнительный инструмент наблюдения за майнингом для пользователей
- **Технологии:** Golang, PostgreSQL, Telegram bot API 
- **Функции:** 
  - Отправка уведомлений от Notification manager нужному получателю в Telegram
  - Фиксация всех сообщений и событий в базе PostgreSQL
  - Получение данных необходимых для уведомлений из других микросервисов
  - Просмотр балансов кошельков
  - Просмотр статусов воркеров
  - Подсчет доходов
  - Уведомления об отключениях воркеров
  - Прочие оповещения







</div>